<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IP Camera Pro</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Inter:wght@400;600&display=swap');

:root {
  --bg: #0d0d0d;
  --panel: rgba(20,20,30,0.95);
  --glass: rgba(30,30,50,0.4);
  --accent: #3b82f6;
  --accent-glow: #60a5fa;
  --danger: #ef4444;
  --live: #10b981;
  --gold: #fbbf24;
}

* { box-sizing: border-box; margin:0; padding:0; }

body {
  background: linear-gradient(135deg, #0f0f1e 0%, #1a0033 100%);
  color: #e0e0ff;
  font-family: 'Inter', sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Video Container */
#video-container { position: relative; flex-grow: 1; background:#000; overflow:hidden; }
video { width:100%; height:100%; object-fit:cover; filter:brightness(1.05) contrast(1.1); transform: scaleX(1); position:relative; z-index: 1; }

#motion-alert {
  position: absolute; inset:0; pointer-events:none; z-index:20; opacity:0;
  box-shadow: inset 0 0 100px var(--danger);
  background: radial-gradient(circle, transparent 40%, rgba(239,68,68,0.4) 100%);
  transition: opacity 0.2s;
}
#motion-alert.active { opacity:1; animation: alertPulse 0.5s infinite; }

/* Preview Overlay */
#preview-overlay {
  position: absolute; inset:0;
  background: linear-gradient(135deg,rgba(15,15,35,.95),rgba(30,10,50,.9));
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  z-index:50; transition:all .8s ease;
}
body.streaming #preview-overlay { opacity:0; pointer-events:none; transform:scale(1.1); }

.preview-content { text-align:center; animation:float 6s ease-in-out infinite; }
.logo-pulse { margin-bottom:32px; animation:logoPulse 2s ease-in-out infinite alternate; }
.logo-pulse svg { width:128px; height:128px; filter:drop-shadow(0 0 30px #3b82f680); }
.preview-content h2 { font:900 42px 'Orbitron',sans-serif; background:linear-gradient(90deg,#60a5fa,#a78bfa,#818cf8); -webkit-background-clip:text; background-clip:text; color:transparent; letter-spacing:3px; }
.preview-content p { font-size:18px; color:#bbbbdd; margin:16px 0 32px; }

/* Overlays */
.overlay {
  position:absolute; padding:10px 16px; background:var(--glass); border:1px solid rgba(100,100,255,.2);
  border-radius:16px; font-weight:600; pointer-events:none; z-index:60; backdrop-filter:blur(12px);
  box-shadow:0 8px 32px rgba(0,0,0,.4); display: flex; align-items: center; gap: 8px;
}
.top-left  { top:20px; left:20px; }
.top-right { top:20px; right:20px; color:var(--live); display:flex; align-items:center; gap:10px; font-weight:700; }
.blink { width:12px; height:12px; background:var(--live); border-radius:50%; animation:blinker 1.4s infinite, pulse 2s infinite; box-shadow:0 0 20px var(--live); }

.bat-icon { width: 24px; height: 12px; border: 1px solid #fff; border-radius: 2px; position: relative; margin-left: 5px; }
.bat-icon::after { content:''; position: absolute; right: -3px; top: 2px; height: 6px; width: 2px; background: #fff; }
.bat-fill { height: 100%; background: var(--live); width: 100%; transition: width 0.5s; }
.bat-low .bat-fill { background: var(--danger); }

/* Control Panel */
#controls {
  background:var(--panel); backdrop-filter:blur(20px); padding:28px; border-radius:28px 28px 0 0;
  box-shadow:0 -20px 40px rgba(0,0,0,.6); position:relative; z-index: 100;
  padding-bottom: 40px; 
}
#controls::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,var(--accent),transparent); opacity:.6; }

h3 { text-align:center; color:#aaa; font-size:13px; text-transform:uppercase; letter-spacing:3px; margin-bottom:16px; }

input, button {
  width:100%; padding:18px; border:none; border-radius:18px; font-size:19px; font-weight:600;
  margin-bottom:12px; transition:all .3s ease;
}
input {
  background:rgba(40,40,60,.6); color:white; border:2px solid rgba(100,100,200,.3);
  text-align:center; letter-spacing:8px; font-family:'Orbitron',monospace; backdrop-filter:blur(8px);
}
input:focus { border-color:var(--accent-glow); box-shadow:0 0 25px rgba(59,130,246,.4); transform:scale(1.02); }

button {
  background:linear-gradient(135deg,var(--accent),#2563eb); color:white; cursor:pointer;
  box-shadow:0 8px 25px rgba(37,99,235,.4); position:relative; overflow:hidden;
}
button:active { transform:scale(.96); }

.secondary-btn { background:rgba(60,60,80,.6); color:#ccc; border:1px solid rgba(150,150,255,.2); backdrop-filter:blur(8px); }

/* NEW: Horizontal Code Row */
.code-row { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 10px 0 20px 0; }

.code-display {
  font:900 48px 'Orbitron',monospace; /* Slightly reduced for fit */
  letter-spacing:6px; margin:0;
  background:linear-gradient(90deg,#fbbf24,#f59e0b,#f97316); -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow:0 0 40px rgba(251,191,36,.6); animation:glow 3s ease-in-out infinite alternate;
}

/* NEW: Power Button (Compact) */
.power-btn {
    width: 64px; height: 64px; padding: 0; margin: 0;
    border-radius: 18px; 
    background: linear-gradient(135deg, #ef4444, #991b1b);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 15px rgba(239,68,68,0.4);
    flex-shrink: 0;
}
.power-btn svg { width: 32px; height: 32px; fill: white; }

.divider { position:relative; text-align:center; margin:24px 0; color:#666; font-size:13px; font-weight:600; }
.divider span { background:var(--panel); padding:0 20px; position:relative; z-index:1; }
.divider::before { content:''; position:absolute; top:50%; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,#444,transparent); }

.hidden { display:none !important; }

/* Host Tools */
.host-tools { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.tool-btn { font-size: 14px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #aaa; }
.tool-btn.active { background: rgba(59, 130, 246, 0.2); border-color: var(--accent); color: var(--accent); }

/* Anti-Theft Toggle */
.security-row { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 18px; margin-bottom: 20px; border: 1px solid rgba(239, 68, 68, 0.3); }
.security-label { font-weight: bold; color: var(--danger); display: flex; align-items: center; gap: 10px; }
.toggle-switch { position: relative; width: 60px; height: 34px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--danger); box-shadow: 0 0 15px var(--danger); }
input:checked + .slider:before { transform: translateX(26px); }

/* Viewer Back Button */
#viewer-back-btn {
  position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 100;
  padding: 16px 40px; background: linear-gradient(135deg, #ef4444, #991b1b); color: white;
  border: none; border-radius: 50px; font-size: 18px; font-weight: bold;
  box-shadow: 0 10px 30px rgba(239,68,68,.6); backdrop-filter: blur(10px);
}

/* Gallery & Animations */
#fab-gallery {
  position: fixed; bottom: 180px; right: 20px; z-index: 900; 
  width: 60px; height: 60px; border-radius: 50%; 
  background: var(--panel); border: 2px solid var(--accent);
  color: var(--accent); display: flex; align-items: center; justify-content: center; 
  cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.7); 
  transition: transform 0.2s;
}
#fab-gallery:active { transform: scale(0.9); }

#gallery-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; padding: 20px; }
#gallery-modal.open { display: flex; }
.gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom:10px; border-bottom:1px solid #333; }
.gallery-header h2 { color: var(--danger); font-family: 'Orbitron'; letter-spacing: 2px; font-size: 20px; }
.close-modal { background: none; border: none; color: #fff; font-size: 30px; width: auto; padding: 0; box-shadow: none; margin:0; }
.gallery-content { flex-grow: 1; overflow-y: auto; }
.gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding-bottom: 50px; }
.gallery-item { position: relative; border: 1px solid #333; border-radius: 12px; overflow: hidden; background:#111; }
.gallery-item img { width: 100%; height: 150px; object-fit: cover; display: block; }
.gallery-info { padding: 10px; display: flex; justify-content: space-between; align-items: center; background: rgba(20,20,30,0.9); }
.gallery-ts { color: var(--gold); font-size: 11px; font-family: monospace; }
.download-btn { background: var(--accent); color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 11px; cursor: pointer; box-shadow: none; width: auto; margin:0; }

@keyframes alertPulse { 0% { opacity:0.6; } 50% { opacity:1; } 100% { opacity:0.6; } }
@keyframes blinker { 50% { opacity:.4; } }
@keyframes pulse { 0%,100% { box-shadow:0 0 20px var(--live); } 50% { box-shadow:0 0 35px var(--live),0 0 50px rgba(16,185,129,.4); } }
@keyframes logoPulse { from { transform:scale(1); } to { transform:scale(1.12); } }
@keyframes float { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-20px); } }
@keyframes glow { from { text-shadow:0 0 30px rgba(251,191,36,.5); } to { text-shadow:0 0 60px rgba(251,191,36,.9); } }
@keyframes shine { 0% { transform:translateX(-100%) translateY(-100%) rotate(45deg); } 100% { transform:translateX(100%) translateY(100%) rotate(45deg); } }
</style>
</head>
<body>

<div id="video-container">
  <video id="vid" autoplay playsinline muted></video>
  <div id="motion-alert"></div>

  <div id="preview-overlay">
    <div class="preview-content">
      <div class="logo-pulse">
        <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="#3b82f6" stroke-width="2" opacity=".3"/><path d="M9 8L16 12L9 16V8Z" fill="#3b82f6"/></svg>
      </div>
      <h2>IP Camera Pro</h2>
      <p>v2.9 UI Fix</p>
    </div>
  </div>

  <div class="overlay top-left">
      <span id="status">Ready</span>
      <div id="battery-level" style="display:flex; align-items:center; margin-left:10px; font-size:11px; opacity:0.8;">
          <span id="bat-txt">--%</span>
          <div class="bat-icon"><div class="bat-fill" id="bat-bar"></div></div>
      </div>
  </div>

  <div class="overlay top-right hidden" id="viewer-tag">
    <div class="blink"></div> LIVE
    <span style="margin-left:8px;color:white">Viewers: <span id="count">0</span></span>
  </div>
</div>

<div id="controls">
  <div id="menu">
    <h3>Setup Console</h3>
    
    <div class="security-row">
      <div class="security-label">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
        ANTI-THEFT MODE
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="theft-toggle">
        <span class="slider"></span>
      </label>
    </div>

    <button onclick="startHost()">Start Host (Auto-Cam)</button>
    <div class="divider"><span>OR JOIN AS VIEWER</span></div>
    <input type="tel" id="remoteCode" placeholder="0000" maxlength="4">
    <button class="secondary-btn" onclick="startViewer()">Connect to Code</button>
  </div>

  <div id="host-ui" class="hidden">
    <h3>Your Connection Code</h3>
    
    <div class="code-row">
        <div id="my-code-display" class="code-display">...</div>
        <button class="power-btn" onclick="goBackToMenu()" title="Stop & Exit">
            <svg viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
        </button>
    </div>
    
    <div class="host-tools">
        <button id="btn-torch" class="tool-btn" onclick="toggleTorch()">âš¡ Flashlight</button>
        <button id="btn-mic" class="tool-btn" onclick="toggleMic()">ðŸŽ¤ Mute Mic</button>
    </div>

    <p style="text-align:center;color:#888;margin:15px 0;">Enter this code on the other device</p>
    <p id="security-status" style="text-align:center;color:var(--danger);font-weight:bold;display:none;">[ ANTI-THEFT ACTIVE ]</p>
  </div>
</div>

<button id="viewer-back-btn" class="hidden" onclick="goBackToMenu()">Disconnect</button>

<div id="fab-gallery" class="hidden" onclick="openGallery()" title="Open Security Gallery">
  <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
</div>

<div id="gallery-modal">
  <div class="gallery-header">
    <h2>SECURITY LOGS</h2>
    <div style="display:flex; gap:15px; align-items:center;">
       <button id="clear-btn" class="secondary-btn" style="padding:5px 10px; font-size:12px; margin:0; width:auto; display:none;" onclick="clearDatabase()">Clear All</button>
       <button class="close-modal" onclick="document.getElementById('gallery-modal').classList.remove('open')">&times;</button>
    </div>
  </div>
  <div class="gallery-content">
    <div class="gallery-grid" id="gallery-grid"></div>
    <p id="gallery-loader" style="text-align:center; color:#666; display:none;">Syncing data...</p>
  </div>
</div>

<script>
const APP_PREFIX = "spck-cam-sec-v3-";
const video = document.getElementById('vid');
const statusEl = document.getElementById('status');
const viewerTag = document.getElementById('viewer-tag');
const countSpan = document.getElementById('count');
const codeDisplay = document.getElementById('my-code-display');
const viewerBackBtn = document.getElementById('viewer-back-btn');
const theftToggle = document.getElementById('theft-toggle');
const motionAlert = document.getElementById('motion-alert');
const galleryGrid = document.getElementById('gallery-grid');
const fabGallery = document.getElementById('fab-gallery');

let peer, localStream, activeConnections = [];
let wakeLock = null;
let isHost = false;
let db = null;
let heartbeatInterval = null;
let isTorchOn = false;
let isMicOn = true;

// STUN Servers to fix connection issues
const PEER_CONFIG = {
    config: {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:global.stun.twilio.com:3478' }
        ]
    }
};

async function initBattery() {
    if ('getBattery' in navigator) {
        const bat = await navigator.getBattery();
        const update = () => {
            const level = Math.round(bat.level * 100);
            document.getElementById('bat-txt').innerText = level + '%';
            document.getElementById('bat-bar').style.width = level + '%';
            if(level < 20) document.getElementById('bat-bar').parentElement.classList.add('bat-low');
        };
        update();
        bat.addEventListener('levelchange', update);
    }
}
initBattery();

function getDB() {
  return new Promise((resolve, reject) => {
    if (db) return resolve(db);
    const request = indexedDB.open("StreamSecurityDB", 2);
    request.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains("photos")) d.createObjectStore("photos", { keyPath: "id" });
    };
    request.onsuccess = e => { db = e.target.result; resolve(db); };
    request.onerror = e => reject("DB_FAIL");
  });
}

async function savePhoto(dataUrl) {
  try {
    const database = await getDB();
    const transaction = database.transaction(["photos"], "readwrite");
    transaction.objectStore("photos").add({ id: Date.now(), image: dataUrl, time: new Date().toLocaleTimeString() });
  } catch(e) { console.error("Save fail", e); }
}

async function getAllPhotos(callback) {
  try {
    const database = await getDB();
    const transaction = database.transaction(["photos"], "readonly");
    const req = transaction.objectStore("photos").getAll();
    req.onsuccess = () => callback(req.result);
  } catch(e) { console.error("Read fail", e); }
}

async function clearDatabase() {
    if(!confirm("Delete all security photos?")) return;
    try {
        const database = await getDB();
        const transaction = database.transaction(["photos"], "readwrite");
        transaction.objectStore("photos").clear();
        document.getElementById('gallery-grid').innerHTML = "";
    } catch(e) { console.error(e); }
}

let motionCanvas = document.createElement('canvas');
let motionCtx = motionCanvas.getContext('2d');
let lastImageData = null;
let motionInterval = null;
let lastCaptureTime = 0;

function startMotionDetection() {
  motionInterval = setInterval(() => {
    if (!localStream || !theftToggle.checked) return;
    const w = 320, h = 240;
    if (motionCanvas.width !== w) { motionCanvas.width = w; motionCanvas.height = h; }
    motionCtx.drawImage(video, 0, 0, w, h);
    const frame = motionCtx.getImageData(0, 0, w, h);
    if (lastImageData) checkDiff(lastImageData.data, frame.data, w, h);
    lastImageData = frame;
  }, 500);
}

function checkDiff(prev, curr, w, h) {
  let diffCount = 0;
  for (let i = 0; i < curr.length; i += 16) { 
    if (Math.abs(prev[i] - curr[i]) + Math.abs(prev[i+1] - curr[i+1]) + Math.abs(prev[i+2] - curr[i+2]) > 100) diffCount++;
  }
  if (diffCount > (w * h / 16) * 0.05) triggerMotionAlert();
}

function triggerMotionAlert() {
  const now = Date.now();
  if (now - lastCaptureTime < 3000) return;
  lastCaptureTime = now;
  motionAlert.classList.add('active');
  setTimeout(() => motionAlert.classList.remove('active'), 1000);
  const c = document.createElement('canvas');
  c.width = video.videoWidth;
  c.height = video.videoHeight;
  c.getContext('2d').drawImage(video, 0, 0);
  savePhoto(c.toDataURL('image/jpeg', 0.5));
}

async function toggleTorch() {
    if(!localStream) return;
    const track = localStream.getVideoTracks()[0];
    const capabilities = track.getCapabilities();
    if (capabilities.torch) {
        isTorchOn = !isTorchOn;
        try {
            await track.applyConstraints({ advanced: [{ torch: isTorchOn }] });
            document.getElementById('btn-torch').classList.toggle('active', isTorchOn);
        } catch(e) {}
    } else {
        alert("Flashlight not supported on this device.");
    }
}

function toggleMic() {
    if(!localStream) return;
    const track = localStream.getAudioTracks()[0];
    isMicOn = !isMicOn;
    track.enabled = isMicOn;
    const btn = document.getElementById('btn-mic');
    if(!isMicOn) {
        btn.classList.add('active');
        btn.innerHTML = "ðŸŽ¤ MIC MUTED";
    } else {
        btn.classList.remove('active');
        btn.innerHTML = "ðŸŽ¤ Mute Mic";
    }
}

async function getCameraStream() {
    return await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: { ideal: "environment" } }, 
        audio: true 
    });
}

async function requestWakeLock() {
  try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
}

function showUI(mode) {
  document.body.classList.add('streaming');
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('controls').style.display = mode === 'host' ? 'flex' : 'none';
  if(mode === 'host') document.getElementById('host-ui').classList.remove('hidden');
  
  if (mode === 'viewer') viewerBackBtn.classList.remove('hidden');
  else viewerBackBtn.classList.add('hidden');

  requestWakeLock();
}

function goBackToMenu() {
  if (localStream) {
      const track = localStream.getVideoTracks()[0];
      if(track) track.applyConstraints({ advanced: [{ torch: false }] }).catch(e=>{});
      localStream.getTracks().forEach(t => t.stop());
  }
  if (peer) { peer.destroy(); peer = null; }
  clearInterval(motionInterval);
  clearInterval(heartbeatInterval);
  activeConnections = [];
  
  document.body.classList.remove('streaming');
  document.getElementById('menu').classList.remove('hidden');
  document.getElementById('host-ui').classList.add('hidden');
  document.getElementById('controls').style.display = 'flex';
  viewerTag.classList.add('hidden');
  viewerBackBtn.classList.add('hidden');
  fabGallery.classList.add('hidden'); 
  statusEl.innerText = "Ready";
  video.srcObject = null;
  countSpan.innerText = "0";
  isHost = false;
  isTorchOn = false; 
  isMicOn = true;
  document.getElementById('btn-torch').classList.remove('active');
  document.getElementById('btn-mic').innerHTML = "ðŸŽ¤ Mute Mic";
  document.getElementById('btn-mic').classList.remove('active');
}

function startHeartbeat() {
    heartbeatInterval = setInterval(() => {
        if(!peer || peer.destroyed) return;
        activeConnections.forEach(conn => {
            if(conn.open) conn.send({type: 'PING'});
        });
    }, 5000);
}

function startHost() {
  isHost = true;
  const shortCode = Math.floor(1000 + Math.random() * 9000);
  codeDisplay.innerText = shortCode;
  
  const isArmed = theftToggle.checked;
  document.getElementById('security-status').style.display = isArmed ? 'block' : 'none';

  getCameraStream()
    .then(stream => {
      localStream = stream;
      video.srcObject = stream;
      video.muted = true; 
      video.volume = 0;
      video.play().catch(e => console.log(e));
      showUI('host');
      
      if (isArmed) fabGallery.classList.remove('hidden');
      statusEl.innerText = isArmed ? "ARMED & STREAMING" : "Streaming Live";
      statusEl.style.color = isArmed ? "var(--danger)" : "white";
      
      if(isArmed) startMotionDetection();

      peer = new Peer(APP_PREFIX + shortCode, PEER_CONFIG);
      
      peer.on('error', err => {
          if(err.type !== 'peer-unavailable') alert("Connection Error: " + err.type);
      });

      peer.on('connection', conn => {
        activeConnections.push(conn);
        updateViewerCount();
        handleData(conn); 
        
        conn.on('open', () => {
            conn.send({ type: 'SYNC_STATUS', security: isArmed });
        });
        conn.on('close', () => { 
            activeConnections = activeConnections.filter(c => c !== conn); 
            updateViewerCount(); 
        });
        peer.call(conn.peer, stream);
        viewerTag.classList.remove('hidden');
      });
      startHeartbeat();
    })
    .catch(e => {
      alert("Camera Start Failed: " + e.message);
      goBackToMenu();
    });
}

function updateViewerCount() {
  countSpan.innerText = activeConnections.length;
}

function startViewer() {
  const code = document.getElementById('remoteCode').value.trim();
  if (code.length !== 4) return alert("Enter 4-digit code");
  isHost = false;
  statusEl.innerText = "Connecting...";
  
  peer = new Peer(null, PEER_CONFIG);
  
  peer.on('error', err => {
      alert("Connection failed. Check code or internet.");
      goBackToMenu();
  });

  peer.on('open', () => {
    const conn = peer.connect(APP_PREFIX + code);
    handleData(conn);
    conn.on('open', () => {
      showUI('viewer');
      statusEl.innerText = "Waiting for video...";
      activeConnections = [conn]; 
      startHeartbeat();
    });
    conn.on('close', () => { alert("Host Disconnected"); goBackToMenu(); });
    
    peer.on('call', call => {
      call.answer();
      call.on('stream', stream => {
        video.srcObject = stream;
        video.muted = false; 
        video.volume = 1;
        video.play().catch(e => console.log(e));
        viewerTag.classList.remove('hidden');
        countSpan.parentElement.style.display = 'none';
        statusEl.innerText = "Connected";
      });
    });
  });
}

function handleData(conn) {
  conn.on('data', data => {
    if (data.type === 'SYNC_STATUS' && !isHost) {
        if (data.security) fabGallery.classList.remove('hidden');
        else fabGallery.classList.add('hidden');
    }
    if (data.type === 'GET_LOGS' && isHost) {
      getAllPhotos(photos => conn.send({ type: 'LOG_DATA', photos: photos ? photos.reverse() : [] }));
    }
    if (data.type === 'LOG_DATA' && !isHost) {
      renderGallery(data.photos);
    }
  });
}

function openGallery() {
  document.getElementById('gallery-modal').classList.add('open');
  const loader = document.getElementById('gallery-loader');
  
  if (isHost) {
    document.getElementById('clear-btn').style.display = 'block';
    loader.style.display = 'none';
    getAllPhotos(photos => renderGallery(photos ? photos.reverse() : []));
  } else {
    document.getElementById('clear-btn').style.display = 'none';
    galleryGrid.innerHTML = ""; 
    loader.style.display = 'block';
    if(activeConnections[0]) activeConnections[0].send({ type: 'GET_LOGS' });
  }
}

function renderGallery(photos) {
  document.getElementById('gallery-loader').style.display = 'none';
  galleryGrid.innerHTML = "";
  if(!photos || photos.length === 0) {
    galleryGrid.innerHTML = "<p style='color:#666;grid-column:span 2;text-align:center;'>No incidents recorded.</p>";
    return;
  }
  photos.forEach(p => {
    const div = document.createElement('div');
    div.className = 'gallery-item';
    div.innerHTML = `
      <img src="${p.image}">
      <div class="gallery-info">
        <span class="gallery-ts">${p.time}</span>
        <button class="download-btn" onclick="downloadImage('${p.image}', '${p.id}')">SAVE</button>
      </div>`;
    galleryGrid.appendChild(div);
  });
}

function downloadImage(base64, id) {
  const link = document.createElement('a');
  link.href = base64;
  link.download = `security_capture_${id}.jpg`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
</body>
</html>
