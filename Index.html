<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>IP Camera Pro - Ultimate Control</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Inter:wght@400;600&display=swap');

:root {
  --bg: #0d0d0d;
  --panel: rgba(15,15,25,0.95);
  --glass: rgba(30,30,50,0.4);
  --accent: #3b82f6;
  --accent-glow: #60a5fa;
  --danger: #ef4444;
  --live: #10b981;
  --gold: #fbbf24;
}

* { box-sizing: border-box; margin:0; padding:0; outline:none; -webkit-tap-highlight-color: transparent; }

body {
  background: #050510;
  color: #e0e0ff;
  font-family: 'Inter', sans-serif;
  height: 100dvh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Night Vision Filter - Applied to Video Element */
.night-vision-mode {
    filter: grayscale(100%) contrast(150%) brightness(130%) sepia(20%) hue-rotate(180deg) !important;
}

#video-container { position: relative; flex-grow: 1; background:#000; overflow:hidden; }
video { width:100%; height:100%; object-fit:cover; filter:brightness(1.05) contrast(1.1); transform: scale(1); transform-origin: center; transition: transform 0.2s ease-out; position:relative; z-index: 1; }

#remote-audio { display: none; }

#motion-alert {
  position: absolute; inset:0; pointer-events:none; z-index:20; opacity:0;
  box-shadow: inset 0 0 100px var(--danger);
  background: radial-gradient(circle, transparent 40%, rgba(239,68,68,0.4) 100%);
  transition: opacity 0.2s;
}
#motion-alert.active { opacity:1; animation: alertPulse 0.5s infinite; }

#audio-visualizer {
  position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
  z-index: 10; pointer-events: none; opacity: 0.8;
}

#preview-overlay {
  position: absolute; inset:0;
  background: 
    linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
    linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(255, 0, 0, 0.03) 1px, transparent 1px), 
    linear-gradient(rgba(255, 0, 0, 0.06), rgba(255, 0, 0, 0.03) 1px, transparent 1px);
  background-size: 100% 2px, 20px 100%, 100% 20px;
  background-color: #0b0b15;
  display:flex; flex-direction:column; 
  align-items:center; justify-content: center;
  padding-bottom: 10vh; padding-top: 5vh;
  z-index:50; transition:all .8s ease;
}
body.streaming #preview-overlay { opacity:0; pointer-events:none; transform:scale(1.2); filter: blur(10px); }

.preview-content { text-align:center; position: relative; }

.logo-container {
  position: relative; width: 200px; height: 200px; 
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 25px auto;
}
.ring {
  position: absolute; inset: 0; border-radius: 50%;
  border: 2px dashed rgba(59, 130, 246, 0.3);
  animation: spin 10s linear infinite;
}
.ring::after {
  content:''; position: absolute; inset: -5px; border-radius: 50%;
  border-top: 2px solid var(--accent);
  border-left: 2px solid transparent; border-right: 2px solid transparent; border-bottom: 2px solid transparent;
  animation: spin 2s linear infinite reverse;
}
.logo-pulse svg { 
    width: 110px; height: 110px; filter:drop-shadow(0 0 40px #3b82f6); 
    animation: logoPulse 2s ease-in-out infinite alternate; 
}
.preview-content h2 { 
  font:900 38px 'Orbitron',sans-serif; 
  background:linear-gradient(90deg,#fff, #3b82f6); -webkit-background-clip:text; background-clip:text; color:transparent; 
  letter-spacing:4px; text-transform: uppercase; margin-bottom: 15px;
}
.tech-stats {
  display: flex; gap: 15px; justify-content: center;
  font-family: 'Orbitron', monospace; font-size: 11px; color: #555; letter-spacing: 1px;
}
.tech-stats span { display: flex; align-items: center; gap: 4px; }
.dot { width: 6px; height: 6px; background: var(--live); border-radius: 50%; box-shadow: 0 0 5px var(--live); }

.overlay {
  position:absolute; padding:8px 14px; background:var(--glass); border:1px solid rgba(100,100,255,.2);
  border-radius:16px; font-weight:600; pointer-events:none; z-index:60; backdrop-filter:blur(12px);
  box-shadow:0 8px 32px rgba(0,0,0,.4); display: flex; align-items: center; gap: 8px; font-size: 13px;
}
.top-left  { top:15px; left:15px; }
.top-right { top:15px; right:15px; color:var(--live); display:flex; align-items:center; gap:10px; font-weight:700; }
.blink { width:10px; height:10px; background:var(--live); border-radius:50%; animation:blinker 1.4s infinite, pulse 2s infinite; box-shadow:0 0 20px var(--live); }

.bat-icon { width: 20px; height: 10px; border: 1px solid #fff; border-radius: 2px; position: relative; margin-left: 5px; }
.bat-icon::after { content:''; position: absolute; right: -2px; top: 2px; height: 4px; width: 2px; background: #fff; }
.bat-fill { height: 100%; background: var(--live); width: 100%; transition: width 0.5s; }
.bat-low .bat-fill { background: var(--danger); }

#controls {
  background:var(--panel); backdrop-filter:blur(25px); 
  border-top: 1px solid rgba(255,255,255,0.1);
  padding: 20px 24px;
  border-radius:28px 28px 0 0;
  box-shadow:0 -10px 50px rgba(0,0,0,0.8); 
  position:relative; z-index: 100;
  max-height: 65vh; overflow-y: auto; padding-bottom: 40px;
}

h3 { text-align:center; color:#666; font-size:11px; text-transform:uppercase; letter-spacing:3px; margin-bottom:15px; font-weight: 800; }

input, button {
  width:100%; padding:14px; border:none; border-radius:16px; font-size:16px; font-weight:600;
  margin-bottom:10px; transition:all .2s ease;
}
input {
  background:rgba(0,0,0,.4); color:white; border:1px solid rgba(255,255,255,.1);
  text-align:center; letter-spacing:4px; font-family:'Orbitron',monospace;
}
input:focus { border-color:var(--accent); box-shadow:0 0 15px rgba(59,130,246,.3); }

input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; padding: 0; margin: 10px 0; }
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
  background: var(--accent); cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px var(--accent);
}
input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px; }

.range-label { display:flex; justify-content:space-between; font-size:10px; color:#aaa; font-weight:700; margin-top:-5px; margin-bottom:15px; }

button {
  background:linear-gradient(135deg,var(--accent),#2563eb); color:white; cursor:pointer;
  box-shadow:0 4px 15px rgba(37,99,235,.3); position:relative; overflow:hidden;
}
button:active { transform:scale(.98); }
.secondary-btn { background:rgba(255,255,255,.08); color:#ccc; border:1px solid rgba(255,255,255,.1); }

.code-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0 20px 0; }
.code-display {
  font:900 48px 'Orbitron',monospace; letter-spacing:4px; margin:0;
  background:linear-gradient(90deg,#fbbf24,#f59e0b,#f97316); -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow:0 0 40px rgba(251,191,36,.4); animation:glow 3s ease-in-out infinite alternate;
}

.power-btn {
    width: 60px; height: 60px; padding: 0; margin: 0; border-radius: 16px; 
    background: linear-gradient(135deg, #ef4444, #991b1b);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 15px rgba(239,68,68,0.4); flex-shrink: 0;
}
.power-btn svg { width: 28px; height: 28px; fill: white; }

.divider { position:relative; text-align:center; margin:15px 0; color:#444; font-size:11px; font-weight:700; }
.divider span { background:#13131e; padding:0 15px; position:relative; z-index:1; }
.divider::before { content:''; position:absolute; top:50%; left:0; right:0; height:1px; background:#333; }
.hidden { display:none !important; }

.host-tools { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; margin-top: 5px; } 
.tool-btn { font-size: 10px; padding: 14px 2px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #aaa; transition: 0.2s; white-space: nowrap; text-align: center; border-radius:12px;}
.tool-btn.active { background: rgba(59, 130, 246, 0.2); border-color: var(--accent); color: var(--accent); }
.tool-btn.recording { background: rgba(239, 68, 68, 0.2); border-color: var(--danger); color: var(--danger); animation: pulse 1s infinite; }

.security-row { display: flex; align-items: center; justify-content: space-between; background: rgba(239, 68, 68, 0.1); padding: 12px 16px; border-radius: 16px; margin-bottom: 15px; border: 1px solid rgba(239, 68, 68, 0.3); }
.security-label { font-weight: bold; color: var(--danger); display: flex; align-items: center; gap: 8px; font-size: 13px; }
.toggle-switch { position: relative; width: 46px; height: 24px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--danger); box-shadow: 0 0 10px var(--danger); }
input:checked + .slider:before { transform: translateX(22px); }

/* Viewer Controls Grid Update */
#viewer-controls {
  position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; z-index: 100; align-items: center; justify-content: center;
}
.remote-btn {
  width: 58px; height: 58px; border-radius: 50%; border: none;
  background: rgba(20,20,30,0.9); backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2); color: white;
  display: flex; align-items: center; justify-content: center; flex-direction: column;
  box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; transition: 0.2s; margin: 0 auto;
}
.remote-btn svg { width: 22px; height: 22px; fill: currentColor; margin-bottom: 2px; }
.remote-btn span { font-size: 8px; font-weight: 700; text-transform: uppercase; color: #aaa; }
.remote-btn:active { transform: scale(0.95); }
.remote-btn.active { background: var(--accent); border-color: var(--accent-glow); box-shadow: 0 0 20px var(--accent); color: white; }
.remote-btn.active span { color: white; }

#rem-talk { 
    width: 75px; height: 75px; 
    border: 2px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
}
#rem-talk.talking { background: var(--live); box-shadow: 0 0 25px var(--live); border-color: #4ade80; animation: pulse 1s infinite; }

#viewer-back-btn {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100;
  padding: 14px 35px; background: linear-gradient(135deg, #ef4444, #991b1b); color: white;
  border: none; border-radius: 50px; font-size: 16px; font-weight: bold;
  box-shadow: 0 10px 30px rgba(239,68,68,.6); backdrop-filter: blur(10px);
}

#fab-gallery {
  position: fixed; bottom: 180px; right: 20px; z-index: 900; 
  width: 54px; height: 54px; border-radius: 50%; 
  background: var(--panel); border: 2px solid var(--accent);
  color: var(--accent); display: flex; align-items: center; justify-content: center; 
  cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.7); 
  transition: transform 0.2s;
}
#fab-gallery:active { transform: scale(0.9); }

#gallery-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; padding: 20px; }
#gallery-modal.open { display: flex; }
.gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom:10px; border-bottom:1px solid #333; }
.gallery-header h2 { color: var(--danger); font-family: 'Orbitron'; letter-spacing: 2px; font-size: 18px; }
.close-modal { background: none; border: none; color: #fff; font-size: 28px; width: auto; padding: 0; box-shadow: none; margin:0; }
.gallery-content { flex-grow: 1; overflow-y: auto; }
.gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding-bottom: 50px; }
.gallery-item { position: relative; border: 1px solid #333; border-radius: 10px; overflow: hidden; background:#111; }
.gallery-item img { width: 100%; height: 120px; object-fit: cover; display: block; }
.gallery-info { padding: 8px; display: flex; justify-content: space-between; align-items: center; background: rgba(20,20,30,0.9); }
.gallery-ts { color: var(--gold); font-size: 10px; font-family: monospace; }
.download-btn { background: var(--accent); color: white; border: none; border-radius: 6px; padding: 5px 10px; font-size: 10px; cursor: pointer; box-shadow: none; width: auto; margin:0; }

.app-footer {
    text-align: center;
    color: rgba(255,255,255,0.2);
    font-size: 10px;
    padding: 20px 0 10px 0;
    font-family: 'Inter', sans-serif;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 700;
}

/* Toast System */
#toast {
    visibility: hidden; min-width: 200px; max-width: 90%; background-color: rgba(30,30,40,0.95); color: #fff;
    text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed;
    z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%);
    font-size: 12px; font-weight: 600; box-shadow: 0 4px 25px rgba(0,0,0,0.8);
    border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px);
    transition: bottom 0.3s, opacity 0.3s; opacity: 0;
}
#toast.show { visibility: visible; bottom: 40px; opacity: 1; }

/* Approval Modal */
#approval-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000;
    display: none; align-items: center; justify-content: center; flex-direction: column;
    padding: 20px;
    backdrop-filter: blur(5px);
}
#approval-modal.active { display: flex; }
.approval-box {
    background: var(--panel); border: 1px solid var(--accent);
    padding: 25px; border-radius: 20px; text-align: center;
    width: 100%; max-width: 320px;
    box-shadow: 0 0 50px rgba(59, 130, 246, 0.2);
}
.approval-box h3 { color: var(--accent); margin-bottom: 10px; font-size: 14px; }
.approval-box p { color: #fff; margin-bottom: 20px; font-size: 16px; font-weight: 600; }
.approval-btns { display: flex; gap: 10px; }

#eco-overlay {
    position: fixed; inset: 0; background: #000; z-index: 5000;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
}

@keyframes alertPulse { 0% { opacity:0.6; } 50% { opacity:1; } 100% { opacity:0.6; } }
@keyframes blinker { 50% { opacity:.4; } }
@keyframes pulse { 0%,100% { box-shadow:0 0 20px var(--live); } 50% { box-shadow:0 0 35px var(--live),0 0 50px rgba(16,185,129,.4); } }
@keyframes logoPulse { from { transform:scale(1); } to { transform:scale(1.12); } }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes glow { from { text-shadow:0 0 30px rgba(251,191,36,.5); } to { text-shadow:0 0 60px rgba(251,191,36,.9); } }
</style>
</head>
<body>

<div id="eco-overlay" class="hidden" onclick="toggleEcoMode()">
    <div style="text-align:center; opacity:0.3; color:#333;">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8 8 8z"/></svg>
        <p style="font-family:monospace; margin-top:10px;">TAP TO WAKE</p>
    </div>
</div>

<div id="video-container">
  <video id="vid" autoplay playsinline muted></video>
  <audio id="remote-audio" autoplay></audio> <canvas id="audio-visualizer"></canvas>
  <div id="motion-alert"></div>

  <div id="preview-overlay">
    <div class="preview-content">
      <div class="logo-container">
          <div class="ring"></div>
          <div class="logo-pulse">
            <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="#3b82f6" stroke-width="2" opacity=".3"/><path d="M9 8L16 12L9 16V8Z" fill="#3b82f6"/></svg>
          </div>
      </div>
      <h2>IP Camera Pro</h2>
      <div class="tech-stats">
          <span><div class="dot"></div> ONLINE</span>
          <span><div class="dot" style="background:var(--gold);box-shadow:0 0 5px var(--gold)"></div> SECURE</span>
      </div>
    </div>
  </div>

  <div class="overlay top-left">
      <span id="status">Ready</span>
      <div id="battery-level" style="display:flex; align-items:center; margin-left:10px; font-size:11px; opacity:0.8;">
          <span id="bat-txt">--%</span>
          <div class="bat-icon"><div class="bat-fill" id="bat-bar"></div></div>
      </div>
  </div>

  <div class="overlay top-right hidden" id="viewer-tag">
    <div class="blink"></div> LIVE
    <span style="margin-left:8px;color:white">Viewers: <span id="count">0</span></span>
  </div>
</div>

<div id="controls">
  <div id="menu">
    <h3>Setup Console</h3>
    <div class="security-row">
      <div class="security-label">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
        MOTION DETECTOR
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="theft-toggle">
        <span class="slider"></span>
      </label>
    </div>
    
    <div class="divider" style="margin: 5px 0 5px 0;"><span>MOTION SENSITIVITY</span></div>
    <input type="range" id="sens-slider" min="10" max="250" step="10" value="100">
    <div class="range-label"><span>High (Sensitive)</span><span>Low (Major Movement)</span></div>

    <button onclick="startHost()">Start Host</button>
    <div class="divider"><span>OR JOIN</span></div>
    <div style="display:flex; gap:10px;">
        <input type="tel" id="remoteCode" placeholder="CODE" maxlength="4" style="flex:1; margin:0;">
        <button class="secondary-btn" onclick="startViewer()" style="flex:1; margin:0;">Connect</button>
    </div>
    
    <div class="app-footer">All Rights Reserved Shubham</div>
  </div>

  <div id="host-ui" class="hidden">
    <h3>Connection Code</h3>
    <div class="code-row">
        <div id="my-code-display" class="code-display">...</div>
        <button class="power-btn" onclick="goBackToMenu()" title="Stop & Exit">
            <svg viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
        </button>
    </div>
    <div class="host-tools">
        <button id="btn-torch" class="tool-btn" onclick="toggleTorch()">‚ö° Flash</button>
        <button id="btn-night" class="tool-btn" onclick="toggleNightMode()">üåë Night</button>
        <button id="btn-motion" class="tool-btn" onclick="toggleMotion()">üèÉ Motion</button>
        <button class="tool-btn" onclick="switchCamera()">üîÑ Cam</button>
        
        <button class="tool-btn" onclick="toggleEcoMode()">üåô Eco</button>
        <button id="btn-mic" class="tool-btn" onclick="toggleMic()">üé§ Mic</button>
        <button id="btn-record" class="tool-btn" onclick="toggleRecording()">REC ‚óè</button>
        <button id="btn-speaker" class="tool-btn active" onclick="toggleHostSpeaker()">üîä Spkr</button>
    </div>
    <div class="divider" style="margin: 10px 0 5px 0;"><span>DIGITAL ZOOM</span></div>
    <input type="range" id="zoom-slider" min="1" max="4" step="0.1" value="1" oninput="setZoom(this.value)">
    <p id="security-status" style="text-align:center;color:var(--danger);font-weight:bold;display:none;font-size:12px;margin-top:10px;">[ MOTION DETECTOR: ON ]</p>
  </div>
</div>

<div id="viewer-controls" class="hidden">
    <button id="rem-cam" class="remote-btn" onclick="remoteSwitchCamera()">
        <svg viewBox="0 0 24 24"><path d="M12 6v3.17l2.41-2.41c.78-.78.78-2.05 0-2.83L12 1.59V5h-1c-2.76 0-5 2.24-5 5s2.24 5 5 5h3v-2h-3c-1.66 0-3-1.34-3-3s1.34-3 3-3h1zm6 4c0-2.76-2.24-5-5-5h-1V2l-2.41 2.41c-.78.78-.78 2.05 0 2.83L12 9.66V6h1c1.66 0 3 1.34 3 3s-1.34 3-3 3h-3v2h3c2.76 0 5-2.24 5-5z"/></svg>
        <span>Rotate</span>
    </button>
    
    <button id="rem-night" class="remote-btn" onclick="remoteToggleNight()">
        <svg viewBox="0 0 24 24"><path d="M14 2c1.82 0 3.53.5 5 1.35-2.99 1.73-5 4.95-5 8.65s2.01 6.92 5 8.65A9.973 9.973 0 0114 22C8.48 22 4 17.52 4 12S8.48 2 14 2z"/></svg>
        <span>Night</span>
    </button>
    
    <button id="rem-talk" class="remote-btn" onmousedown="startTalking()" onmouseup="stopTalking()" ontouchstart="startTalking()" ontouchend="stopTalking()">
        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        <span>TALK</span>
    </button>
    
    <button id="rem-snap" class="remote-btn" onclick="takeRemoteSnapshot()">
        <svg viewBox="0 0 24 24"><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
        <span>Snap</span>
    </button>

    <button id="rem-spk" class="remote-btn" onclick="toggleRemoteSpeaker()">
        <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
        <span>Speaker</span>
    </button>

    <button id="rem-torch" class="remote-btn" onclick="remoteToggleTorch()">
        <svg viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>
        <span>Flash</span>
    </button>
</div>

<button id="viewer-back-btn" class="hidden" onclick="goBackToMenu()">Disconnect</button>

<div id="fab-gallery" class="hidden" onclick="openGallery()" title="Gallery">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
</div>

<div id="approval-modal">
    <div class="approval-box">
        <h3>INCOMING CONNECTION</h3>
        <p>A viewer wants to access the camera.</p>
        <div class="approval-btns">
            <button class="secondary-btn" onclick="denyConnection()" style="margin:0;">DENY</button>
            <button onclick="approveConnection()" style="background:var(--live);margin:0;">APPROVE</button>
        </div>
    </div>
</div>

<div id="gallery-modal">
  <div class="gallery-header">
    <h2>SECURITY LOGS</h2>
    <div style="display:flex; gap:10px; align-items:center;">
       <button id="clear-btn" class="secondary-btn" style="padding:5px 10px; font-size:10px; margin:0; width:auto; display:none;" onclick="clearDatabase()">Clear</button>
       <button class="close-modal" onclick="document.getElementById('gallery-modal').classList.remove('open')">&times;</button>
    </div>
  </div>
  <div class="gallery-content">
    <div class="gallery-grid" id="gallery-grid"></div>
    <p id="gallery-loader" style="text-align:center; color:#666; display:none; font-size:12px;">Syncing...</p>
  </div>
</div>

<div id="toast"></div>

<script>
const APP_PREFIX = "spck-cam-sec-v3-";
const video = document.getElementById('vid');
const statusEl = document.getElementById('status');
const viewerTag = document.getElementById('viewer-tag');
const countSpan = document.getElementById('count');
const codeDisplay = document.getElementById('my-code-display');
const viewerBackBtn = document.getElementById('viewer-back-btn');
const theftToggle = document.getElementById('theft-toggle');
const motionAlert = document.getElementById('motion-alert');
const galleryGrid = document.getElementById('gallery-grid');
const fabGallery = document.getElementById('fab-gallery');
const viewerControls = document.getElementById('viewer-controls');
const remoteAudio = document.getElementById('remote-audio');
const toastEl = document.getElementById('toast');
const approvalModal = document.getElementById('approval-modal');
const sensSlider = document.getElementById('sens-slider'); 

let peer, localStream, activeConnections = [];
let viewerStream; 
let wakeLock = null;
let isHost = false;
let db = null;
let heartbeatInterval = null;
let isTorchOn = false;
let isMicOn = true;
let isSpeakerOn = true; 
let isNightMode = false;
let currentFacingMode = "environment";
let toastTimeout;

let connectionQueue = [];
let isHandlingConnection = false;

let mediaRecorder;
let recordedChunks = [];
let isRecording = false;
let audioContext, analyser, dataArray, canvasCtx, visualizerCanvas;

const captureCanvas = document.createElement('canvas'); 
const motionCanvas = document.createElement('canvas');
const motionCtx = motionCanvas.getContext('2d', { willReadFrequently: true });

// === OPTIMIZATION: Better ICE servers (more reliable connection) ===
const PEER_CONFIG = {
    config: {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:global.stun.twilio.com:3478' },
            { urls: 'stun:stun.voipbuster.com:3478' },
            { urls: 'stun:stun.schlund.de:3478' },
            // Free open TURN server (limited bandwidth, but helps in tough networks)
            { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
        ]
    }
};

function showToast(msg) {
    toastEl.innerText = msg;
    toastEl.classList.add('show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { toastEl.classList.remove('show'); }, 3000);
}

document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        await requestWakeLock();
    }
});

async function initBattery() {
    if ('getBattery' in navigator) {
        const bat = await navigator.getBattery();
        const update = () => {
            const level = Math.round(bat.level * 100);
            document.getElementById('bat-txt').innerText = level + '%';
            document.getElementById('bat-bar').style.width = level + '%';
            if(level < 20) document.getElementById('bat-bar').parentElement.classList.add('bat-low');
            else document.getElementById('bat-bar').parentElement.classList.remove('bat-low');
        };
        update();
        bat.addEventListener('levelchange', update);
        bat.addEventListener('chargingchange', update);
    }
}
initBattery();

function getDB() {
  return new Promise((resolve, reject) => {
    if (db) return resolve(db);
    const request = indexedDB.open("StreamSecurityDB", 2);
    request.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains("photos")) d.createObjectStore("photos", { keyPath: "id" });
    };
    request.onsuccess = e => { db = e.target.result; resolve(db); };
    request.onerror = e => reject("DB_FAIL");
  });
}

async function savePhoto(dataUrl) {
  try {
    const database = await getDB();
    const transaction = database.transaction(["photos"], "readwrite");
    transaction.objectStore("photos").add({ id: Date.now(), image: dataUrl, time: new Date().toLocaleTimeString() });
  } catch(e) { console.error("Save fail", e); }
}

async function getAllPhotos(callback) {
  try {
    const database = await getDB();
    const transaction = database.transaction(["photos"], "readonly");
    const req = transaction.objectStore("photos").getAll();
    req.onsuccess = () => callback(req.result);
  } catch(e) { console.error("Read fail", e); }
}

async function clearDatabase() {
    if(!confirm("Delete all security photos?")) return;
    try {
        const database = await getDB();
        const transaction = database.transaction(["photos"], "readwrite");
        transaction.objectStore("photos").clear();
        document.getElementById('gallery-grid').innerHTML = "";
    } catch(e) { console.error(e); }
}

// === OPTIMIZATION: Motion detection improvements ===
let lastImageData = null;
let motionInterval = null;
let lastCaptureTime = 0;
let recentMotion = false;
let adaptiveInterval = 500; // ms

function startMotionDetection() {
  clearInterval(motionInterval);
  adaptiveInterval = 500;
  recentMotion = false;

  motionInterval = setInterval(() => {
    if (!localStream || !theftToggle.checked) {
        document.getElementById('security-status').style.display = 'none';
        document.getElementById('btn-motion').classList.remove('active');
        if(statusEl.innerText.includes("ARMED")) {
             statusEl.innerText = "Streaming";
             statusEl.style.color = "white";
        }
        return;
    }
    
    document.getElementById('security-status').style.display = 'block';
    document.getElementById('btn-motion').classList.add('active');
    if(!statusEl.innerText.includes("ARMED")) {
        statusEl.innerText = "ARMED & STREAMING";
        statusEl.style.color = "var(--danger)";
    }

    const w = 320, h = 240;
    if (motionCanvas.width !== w) { motionCanvas.width = w; motionCanvas.height = h; }

    // === OPTIMIZATION: Only check center 50% of frame (ROI) ===
    const srcX = w * 0.25;
    const srcY = h * 0.25;
    const srcW = w * 0.5;
    const srcH = h * 0.5;
    motionCtx.drawImage(video, srcX, srcY, srcW, srcH, 0, 0, w, h);

    const frame = motionCtx.getImageData(0, 0, w, h);
    if (lastImageData) {
      const moved = checkDiff(lastImageData.data, frame.data, w, h);
      if (moved) {
        recentMotion = true;
        triggerMotionAlert();
        // Reset adaptive slowdown on motion
        adaptiveInterval = 500;
        clearInterval(motionInterval);
        startMotionDetection(); // restart with fast interval
      }
    }
    lastImageData = frame;
  }, adaptiveInterval);

  // === OPTIMIZATION: Slow down to 2s if no motion for 15 seconds ===
  setTimeout(() => {
    if (!recentMotion && theftToggle.checked) {
      adaptiveInterval = 2000;
      clearInterval(motionInterval);
      startMotionDetection();
    }
  }, 15000);
}

function toggleMotion() {
    theftToggle.checked = !theftToggle.checked;
    const btn = document.getElementById('btn-motion');
    const statusTxt = document.getElementById('security-status');
    
    if(theftToggle.checked) {
        btn.classList.add('active');
        statusTxt.innerText = "[ MOTION DETECTOR: ON ]";
        statusTxt.style.color = "var(--danger)";
        showToast("Motion Detection Enabled");
        recentMotion = false;
        startMotionDetection();
    } else {
        btn.classList.remove('active');
        statusTxt.innerText = "[ MOTION DETECTOR: OFF ]";
        statusTxt.style.color = "#888"; 
        statusTxt.style.display = 'block'; 
        showToast("Motion Detection Disabled");
        clearInterval(motionInterval);
    }
    broadcastState();
}

// Faster luminance-only comparison + cooldown
function checkDiff(prev, curr, w, h) {
  let diffCount = 0;
  const sensitivity = parseInt(sensSlider.value);
  const totalPixels = w * h;

  for (let i = 0; i < curr.length; i += 16) {
    const lumPrev = prev[i] * 0.299 + prev[i+1] * 0.587 + prev[i+2] * 0.114;
    const lumCurr = curr[i] * 0.299 + curr[i+1] * 0.587 + curr[i+2] * 0.114;
    if (Math.abs(lumPrev - lumCurr) > sensitivity / 10) diffCount++;
  }

  return diffCount > totalPixels * 0.004; // ~0.4% changed pixels
}

function triggerMotionAlert() {
  const now = Date.now();
  if (now - lastCaptureTime < 4000) return; // 4s cooldown
  lastCaptureTime = now;

  motionAlert.classList.add('active');
  setTimeout(() => motionAlert.classList.remove('active'), 1000);
  
  captureCanvas.width = video.videoWidth || 1280;
  captureCanvas.height = video.videoHeight || 720;
  const ctx = captureCanvas.getContext('2d');
  ctx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
  
  savePhoto(captureCanvas.toDataURL('image/jpeg', 0.4));
  showToast("Motion Detected! Saved to Log.");
}

function setZoom(val) {
  video.style.transform = `scale(${val})`;
  if(isHost) {
      activeConnections.forEach(conn => {
          if(conn.open) conn.send({type: 'ZOOM_SYNC', value: val});
      });
  }
}

function toggleRecording() {
  const btn = document.getElementById('btn-record');
  if (!isRecording) {
    if (!localStream) return showToast("No stream to record");
    recordedChunks = [];
    let options = { mimeType: 'video/webm;codecs=vp9' };
    if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' };
    try {
        mediaRecorder = new MediaRecorder(localStream, options);
    } catch (e) {
        showToast("Recording not supported on this device/browser");
        return;
    }
    mediaRecorder.ondataavailable = (event) => { if (event.data.size > 0) recordedChunks.push(event.data); };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.style.display = 'none'; a.href = url;
      a.download = 'security_clip_' + Date.now() + '.webm';
      document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url);
    };
    mediaRecorder.start();
    isRecording = true;
    btn.innerHTML = "STOP ‚ñ†"; btn.classList.add('recording');
  } else {
    mediaRecorder.stop();
    isRecording = false;
    btn.innerHTML = "REC ‚óè"; btn.classList.remove('recording');
  }
}

function initAudioVisualizer(stream) {
  visualizerCanvas = document.getElementById('audio-visualizer');
  canvasCtx = visualizerCanvas.getContext('2d');
  visualizerCanvas.width = visualizerCanvas.offsetWidth * devicePixelRatio;
  visualizerCanvas.height = visualizerCanvas.offsetHeight * devicePixelRatio;
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const source = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 64; 
  source.connect(analyser);
  const bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
  drawVisualizer();
}

function drawVisualizer() {
  if(!localStream || !isHost) return; 
  requestAnimationFrame(drawVisualizer);
  analyser.getByteFrequencyData(dataArray);
  canvasCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
  const barWidth = (visualizerCanvas.width / dataArray.length) * 2.5;
  let barHeight; let x = 0;
  for(let i = 0; i < dataArray.length; i++) {
    barHeight = dataArray[i] / 2;
    const alpha = barHeight / 120; 
    canvasCtx.fillStyle = `rgba(59, 130, 246, ${alpha})`; 
    canvasCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);
    x += barWidth + 1;
  }
}

async function toggleTorch(fromRemote = false) {
    if(!localStream) return;
    const track = localStream.getVideoTracks()[0];
    if(!track) return;
    isTorchOn = !isTorchOn;
    try { await track.applyConstraints({ advanced: [{ torch: isTorchOn }] }); } catch(e) {}
    updateHardwareUI();
    broadcastState();
}

function toggleNightMode() {
    isNightMode = !isNightMode;
    const btn = document.getElementById('btn-night');
    if(isNightMode) {
        video.classList.add('night-vision-mode');
        btn.classList.add('active');
    } else {
        video.classList.remove('night-vision-mode');
        btn.classList.remove('active');
    }
    broadcastState();
}

async function switchCamera() {
    if (!localStream) return;
    
    localStream.getVideoTracks().forEach(track => track.stop());
    
    currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
    
    try {
        const newStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: { ideal: currentFacingMode },
                width: { ideal: 1280, max: 1280 },
                height: { ideal: 720, max: 720 },
                frameRate: { ideal: 20, max: 24 }
            },
            audio: false 
        });
        
        const newVideoTrack = newStream.getVideoTracks()[0];
        
        if (currentFacingMode === "environment" && isTorchOn) {
            try { await newVideoTrack.applyConstraints({ advanced: [{ torch: true }] }); } catch(e){}
        }

        const oldVideoTrack = localStream.getVideoTracks()[0];
        localStream.removeTrack(oldVideoTrack);
        localStream.addTrack(newVideoTrack);
        
        video.srcObject = localStream;
        
        activeConnections.forEach(conn => {
            if(peer && peer.connections[conn.peer]) {
                peer.connections[conn.peer].forEach(pcWrapper => {
                    const senders = pcWrapper.peerConnection.getSenders();
                    const sender = senders.find(s => s.track && s.track.kind === 'video');
                    if(sender) {
                        sender.replaceTrack(newVideoTrack).catch(err => console.error("Track replace failed", err));
                    }
                });
            }
        });
        
        showToast("Camera Switched");
        
    } catch(e) {
        showToast("Camera Switch Failed");
        console.error(e);
    }
}

function toggleMic() {
    if(!localStream) return;
    const track = localStream.getAudioTracks()[0];
    isMicOn = !isMicOn;
    track.enabled = isMicOn;
    updateHardwareUI();
    broadcastState(); 
}

function toggleHostSpeaker() {
    isSpeakerOn = !isSpeakerOn;
    remoteAudio.muted = !isSpeakerOn;
    if(isSpeakerOn) remoteAudio.volume = 1.0; 
    const btn = document.getElementById('btn-speaker');
    if(isSpeakerOn) { btn.classList.add('active'); btn.innerHTML = "üîä Spkr"; } 
    else { btn.classList.remove('active'); btn.innerHTML = "üîá Muted"; }
}

function updateHardwareUI() {
    document.getElementById('btn-torch').classList.toggle('active', isTorchOn);
    const micBtn = document.getElementById('btn-mic');
    if(!isMicOn) { micBtn.classList.add('active'); micBtn.innerHTML = "üé§ MUTED"; } 
    else { micBtn.classList.remove('active'); micBtn.innerHTML = "üé§ Mic"; }
}

function toggleEcoMode() {
    const eco = document.getElementById('eco-overlay');
    eco.classList.toggle('hidden');
}

function remoteToggleTorch() {
    if(activeConnections[0] && activeConnections[0].open) {
        activeConnections[0].send({type: 'REMOTE_TORCH'});
        animateButton('rem-torch');
    }
}

function remoteToggleNight() {
    if(activeConnections[0] && activeConnections[0].open) {
        activeConnections[0].send({type: 'REMOTE_NIGHT_TOGGLE'});
        animateButton('rem-night');
    }
}

function remoteSwitchCamera() {
    if(activeConnections[0] && activeConnections[0].open) {
        activeConnections[0].send({type: 'REMOTE_SWITCH_CAM'});
        animateButton('rem-cam');
    }
}

function animateButton(id) {
    const btn = document.getElementById(id);
    btn.style.borderColor = 'var(--accent)';
    setTimeout(() => btn.style.borderColor = 'rgba(255,255,255,0.2)', 200);
}

function takeRemoteSnapshot() {
    if(!video.srcObject) return;
    const cvs = document.createElement('canvas');
    cvs.width = video.videoWidth || 1280;
    cvs.height = video.videoHeight || 720;
    const ctx = cvs.getContext('2d');
    
    if(video.classList.contains('night-vision-mode')) {
        ctx.filter = 'grayscale(100%) contrast(150%) brightness(130%) sepia(20%) hue-rotate(180deg)';
    }
    
    ctx.drawImage(video, 0, 0, cvs.width, cvs.height);
    const data = cvs.toDataURL('image/jpeg', 0.8);
    const link = document.createElement('a');
    link.href = data;
    link.download = `remote_snapshot_${Date.now()}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast("Snapshot Saved");
}

function toggleRemoteSpeaker() {
    const btn = document.getElementById('rem-spk');
    if (video.muted) {
        video.muted = false;
        video.volume = 1.0;
        btn.classList.add('active');
    } else {
        video.muted = true;
        btn.classList.remove('active');
    }
}

function startTalking() {
    if(viewerStream) {
        viewerStream.getAudioTracks()[0].enabled = true;
        document.getElementById('rem-talk').classList.add('talking');
    }
}

function stopTalking() {
    if(viewerStream) {
        viewerStream.getAudioTracks()[0].enabled = false;
        document.getElementById('rem-talk').classList.remove('talking');
    }
}

function updateViewerUI(state) {
    document.getElementById('rem-torch').classList.toggle('active', state.torch);
    document.getElementById('rem-night').classList.toggle('active', state.night);
    if(state.night) video.classList.add('night-vision-mode'); else video.classList.remove('night-vision-mode');
}

function broadcastState() {
    const state = { type: 'STATE_UPDATE', torch: isTorchOn, mic: isMicOn, motion: theftToggle.checked, night: isNightMode };
    activeConnections.forEach(conn => {
        if(conn.open) conn.send(state);
    });
}

// === OPTIMIZATION: Lower resolution + capped frame rate for better battery ===
async function getCameraStream() {
    return await navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: { ideal: currentFacingMode },
            width: { ideal: 1280, max: 1280 },
            height: { ideal: 720, max: 720 },
            frameRate: { ideal: 20, max: 24 }
        },
        audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
        }
    });
}

async function requestWakeLock() {
  try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
}

function showUI(mode) {
  document.body.classList.add('streaming');
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('controls').style.display = mode === 'host' ? 'flex' : 'none';
  if(mode === 'host') document.getElementById('host-ui').classList.remove('hidden');
  
  if (mode === 'viewer') {
      viewerBackBtn.classList.remove('hidden');
      viewerControls.classList.remove('hidden');
      video.muted = true; 
      const btn = document.getElementById('rem-spk');
      btn.classList.remove('active');
  } else {
      viewerBackBtn.classList.add('hidden');
      viewerControls.classList.add('hidden');
  }
  requestWakeLock();
}

function goBackToMenu() {
  if (localStream) {
      const track = localStream.getVideoTracks()[0];
      if(track) track.applyConstraints({ advanced: [{ torch: false }] }).catch(e=>{});
      localStream.getTracks().forEach(t => t.stop());
  }
  if (viewerStream) { viewerStream.getTracks().forEach(t => t.stop()); viewerStream = null; }
  
  if (isRecording && mediaRecorder) { mediaRecorder.stop(); isRecording = false; }
  if (audioContext) { audioContext.close(); audioContext = null; }
  
  document.getElementById('zoom-slider').value = 1;
  video.style.transform = 'scale(1)';

  if (peer) { peer.destroy(); peer = null; }
  clearInterval(motionInterval);
  clearInterval(heartbeatInterval);
  activeConnections = [];
  connectionQueue = []; 
  approvalModal.classList.remove('active');
  
  document.body.classList.remove('streaming');
  document.getElementById('menu').classList.remove('hidden');
  document.getElementById('host-ui').classList.add('hidden');
  document.getElementById('controls').style.display = 'flex';
  viewerTag.classList.add('hidden');
  viewerBackBtn.classList.add('hidden');
  viewerControls.classList.add('hidden');
  fabGallery.classList.add('hidden'); 
  statusEl.innerText = "Ready";
  statusEl.style.color = "#e0e0ff";
  document.getElementById('security-status').style.display = 'none';
  video.srcObject = null;
  countSpan.innerText = "0";
  isHost = false;
  isTorchOn = false; isMicOn = true; isSpeakerOn = true; isNightMode = false;
  video.classList.remove('night-vision-mode');
  updateHardwareUI();
}

function startHeartbeat() {
    heartbeatInterval = setInterval(() => {
        if(!peer || peer.destroyed) return;
        activeConnections.forEach(conn => {
            if(conn.open) conn.send({type: 'PING'});
        });
    }, 5000);
}

function processConnectionQueue() {
    if (connectionQueue.length > 0 && !approvalModal.classList.contains('active')) {
        approvalModal.classList.add('active');
    }
}

function approveConnection() {
    approvalModal.classList.remove('active');
    const conn = connectionQueue.shift(); 
    
    if(!conn) return;

    const isArmed = theftToggle.checked;
    
    activeConnections.push(conn);
    updateViewerCount();
    handleData(conn);

    const call = peer.call(conn.peer, localStream);
    call.on('stream', remoteStream => {
        remoteAudio.srcObject = remoteStream;
        remoteAudio.play().catch(e => console.log("Audio play err", e));
    });

    conn.send({ type: 'SYNC_STATUS', security: isArmed });
    conn.send({ type: 'STATE_UPDATE', torch: isTorchOn, mic: isMicOn, motion: isArmed, night: isNightMode });
    conn.send({ type: 'ZOOM_SYNC', value: document.getElementById('zoom-slider').value });

    viewerTag.classList.remove('hidden');
    showToast("Viewer Connected");
    
    setTimeout(processConnectionQueue, 500);
}

function denyConnection() {
    approvalModal.classList.remove('active');
    const conn = connectionQueue.shift();
    
    if(conn) {
        conn.send({ type: 'ACCESS_DENIED' });
        setTimeout(() => { conn.close(); }, 500);
    }
    
    setTimeout(processConnectionQueue, 500);
}

function startHost() {
  isHost = true;
  const shortCode = Math.floor(1000 + Math.random() * 9000);
  codeDisplay.innerText = shortCode;
  
  getCameraStream().then(stream => {
      localStream = stream;
      video.srcObject = stream;
      video.muted = true; video.volume = 0; 
      video.play().catch(e => console.log(e));
      showUI('host');
      fabGallery.classList.remove('hidden');

      initAudioVisualizer(stream); 
      
      statusEl.innerText = "Streaming";
      startMotionDetection(); 

      peer = new Peer(APP_PREFIX + shortCode, PEER_CONFIG);
      peer.on('error', err => { 
          if(err.type !== 'peer-unavailable') showToast("Connection Error: " + err.type); 
      });

      peer.on('disconnected', () => {
          if (!peer.destroyed) {
              showToast("Connection lost. Reconnecting...");
              peer.reconnect();
          }
      });

      peer.on('connection', conn => {
          conn.on('open', () => {
              connectionQueue.push(conn);
              processConnectionQueue();
          });
          conn.on('close', () => {
              activeConnections = activeConnections.filter(c => c !== conn);
              connectionQueue = connectionQueue.filter(c => c !== conn);
              updateViewerCount();
          });
      });
      
      startHeartbeat();
    })
    .catch(e => { showToast("Camera Start Failed: " + e.message); goBackToMenu(); });
}

function updateViewerCount() { countSpan.innerText = activeConnections.length; }

function startViewer() {
  const code = document.getElementById('remoteCode').value.trim();
  if (code.length !== 4) return showToast("Enter 4-digit code");
  
  navigator.mediaDevices.getUserMedia({ 
      audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
      } 
  }).then(vStream => {
      viewerStream = vStream;
      viewerStream.getAudioTracks()[0].enabled = false; 

      isHost = false;
      statusEl.innerText = "Connecting...";
      peer = new Peer(null, PEER_CONFIG);
      
      peer.on('error', err => { showToast("Connection failed. Check code."); goBackToMenu(); });

      peer.on('disconnected', () => {
          if (!peer.destroyed) {
              showToast("Connection lost. Reconnecting...");
              peer.reconnect();
          }
      });

      peer.on('open', () => {
        const conn = peer.connect(APP_PREFIX + code);
        handleData(conn);
        conn.on('open', () => {
          showUI('viewer');
          statusEl.innerText = "Waiting for Host Approval...";
          activeConnections = [conn]; 
          startHeartbeat();
        });
        
        conn.on('close', () => { 
             showToast("Connection Closed"); 
             goBackToMenu(); 
        });
        
        peer.on('call', call => {
          call.answer(viewerStream);
          call.on('stream', stream => {
            if (video.srcObject && video.srcObject.id === stream.id) return;
            video.srcObject = stream;
            video.muted = true; 
            
            const playPromise = video.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    if (error.name === 'AbortError') console.log("Stream play interrupted (normal)");
                    else console.error("Play error:", error);
                });
            }

            viewerTag.classList.remove('hidden');
            countSpan.parentElement.style.display = 'none';
            statusEl.innerText = "Connected";
          });
        });
      });
  }).catch(e => {
      showToast("Microphone access is required for Two-Way Audio.");
      goBackToMenu();
  });
}

function handleData(conn) {
  conn.on('data', data => {
    if (isHost) {
        if (data.type === 'GET_LOGS') getAllPhotos(photos => conn.send({ type: 'LOG_DATA', photos: photos ? photos.reverse() : [] }));
        if (data.type === 'REMOTE_TORCH') toggleTorch(true);
        if (data.type === 'REMOTE_SWITCH_CAM') switchCamera();
        if (data.type === 'REMOTE_NIGHT_TOGGLE') toggleNightMode();
    }
    if (!isHost) {
        if (data.type === 'ACCESS_DENIED') {
            alert("Host denied your connection request.");
            goBackToMenu();
        }
        if (data.type === 'SYNC_STATUS') {
            if (data.security) fabGallery.classList.remove('hidden'); else fabGallery.classList.add('hidden');
        }
        if (data.type === 'LOG_DATA') renderGallery(data.photos);
        if (data.type === 'STATE_UPDATE') updateViewerUI(data);
        if (data.type === 'ZOOM_SYNC') video.style.transform = `scale(${data.value})`;
    }
  });
}

function openGallery() {
  document.getElementById('gallery-modal').classList.add('open');
  const loader = document.getElementById('gallery-loader');
  if (isHost) {
    document.getElementById('clear-btn').style.display = 'block'; loader.style.display = 'none';
    getAllPhotos(photos => renderGallery(photos ? photos.reverse() : []));
  } else {
    document.getElementById('clear-btn').style.display = 'none'; galleryGrid.innerHTML = ""; loader.style.display = 'block';
    if(activeConnections[0]) activeConnections[0].send({ type: 'GET_LOGS' });
  }
}

function renderGallery(photos) {
  document.getElementById('gallery-loader').style.display = 'none'; galleryGrid.innerHTML = "";
  if(!photos || photos.length === 0) { galleryGrid.innerHTML = "<p style='color:#666;grid-column:span 2;text-align:center;'>No incidents recorded.</p>"; return; }
  photos.forEach(p => {
    const div = document.createElement('div'); div.className = 'gallery-item';
    div.innerHTML = `<img src="${p.image}"><div class="gallery-info"><span class="gallery-ts">${p.time}</span><button class="download-btn" onclick="downloadImage('${p.image}', '${p.id}')">SAVE</button></div>`;
    galleryGrid.appendChild(div);
  });
}

function downloadImage(base64, id) {
  const link = document.createElement('a'); link.href = base64; link.download = `security_capture_${id}.jpg`;
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
}
</script>
</body>
</html>
